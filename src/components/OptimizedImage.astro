---
/**
 * Optimierte Bild-Komponente mit:
 * - WebP Support mit Fallback (nur wenn WebP-Datei existiert)
 * - Lazy Loading
 * - Responsive Images
 * - Aspect Ratio Preservation
 */

import fs from 'node:fs';
import path from 'node:path';

interface Props {
  src: string;
  alt: string;
  class?: string;
  loading?: 'lazy' | 'eager';
  sizes?: string;
  aspectRatio?: 'video' | 'square' | 'landscape' | 'portrait' | 'none';
  priority?: boolean;
}

const {
  src,
  alt,
  class: className = '',
  loading = 'lazy',
  sizes = '100vw',
  aspectRatio = 'video',
  priority = false,
} = Astro.props;

// WebP-Version des Bildes
const webpSrc = src?.replace(/\.(jpg|jpeg|png)$/i, '.webp');

// Zur Build-Time prüfen, ob die WebP-Datei tatsächlich existiert
let webpExists = false;
if (webpSrc && webpSrc !== src) {
  try {
    const publicDir = path.resolve(process.cwd(), 'public');
    const webpPath = path.join(publicDir, webpSrc);
    webpExists = fs.existsSync(webpPath);
  } catch {
    webpExists = false;
  }
}

// Aspect Ratio CSS Classes
const aspectClasses = {
  video: 'aspect-video',
  square: 'aspect-square',
  landscape: 'aspect-[4/3]',
  portrait: 'aspect-[3/4]',
  none: '',
};

const finalLoading = priority ? 'eager' : loading;
const fetchPriority = priority ? 'high' : 'auto';
---

<picture class={`block ${aspectClasses[aspectRatio]} ${className}`}>
  <!-- WebP nur anbieten wenn die Datei tatsächlich existiert -->
  {webpExists && (
    <source
      type="image/webp"
      srcset={webpSrc}
      sizes={sizes}
    />
  )}
  
  <!-- Fallback / Original -->
  <img
    src={src}
    alt={alt}
    loading={finalLoading}
    decoding={priority ? 'sync' : 'async'}
    fetchpriority={fetchPriority}
    class="w-full h-full object-cover"
  />
</picture>